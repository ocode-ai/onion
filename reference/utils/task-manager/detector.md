# ğŸ” Provider Detector - Task Manager

## ğŸ¯ Purpose

Detects and validates the configured task management provider, and identifies the origin of task IDs to ensure compatibility.

---

## ğŸ“‹ Main Functions

### detectProvider()

```typescript
/**
 * Detects the configured provider via environment variables.
 * @returns Active provider configuration
 */
function detectProvider(): ProviderConfig {
  const provider = (process.env.TASK_MANAGER_PROVIDER ||
    'none') as TaskManagerProvider;

  const configs: Record<TaskManagerProvider, ProviderConfig> = {
    clickup: {
      provider: 'clickup',
      isConfigured: !!process.env.CLICKUP_API_TOKEN,
      requiredEnvVars: ['CLICKUP_API_TOKEN'],
      optionalEnvVars: ['CLICKUP_WORKSPACE_ID', 'CLICKUP_DEFAULT_LIST_ID'],
      errorMessage: !process.env.CLICKUP_API_TOKEN
        ? 'âŒ CLICKUP_API_TOKEN not configured. Run /meta/setup-integration'
        : undefined,
    },

    asana: {
      provider: 'asana',
      isConfigured: !!process.env.ASANA_ACCESS_TOKEN,
      requiredEnvVars: ['ASANA_ACCESS_TOKEN'],
      optionalEnvVars: ['ASANA_WORKSPACE_ID', 'ASANA_DEFAULT_PROJECT_ID'],
      errorMessage: !process.env.ASANA_ACCESS_TOKEN
        ? 'âŒ ASANA_ACCESS_TOKEN not configured. Run /meta/setup-integration'
        : undefined,
    },

    linear: {
      provider: 'linear',
      isConfigured: !!process.env.LINEAR_API_KEY,
      requiredEnvVars: ['LINEAR_API_KEY'],
      optionalEnvVars: ['LINEAR_TEAM_ID'],
      errorMessage: !process.env.LINEAR_API_KEY
        ? 'âŒ LINEAR_API_KEY not configured. Run /meta/setup-integration'
        : undefined,
    },

    none: {
      provider: 'none',
      isConfigured: true, // Always "configured" as it's the fallback
      requiredEnvVars: [],
      optionalEnvVars: [],
      errorMessage: undefined,
    },
  };

  return configs[provider] || configs.none;
}
```

---

### detectProviderFromTaskId()

```typescript
/**
 * Detects the source provider based on task ID format.
 * @param taskId - Task ID to analyze
 * @returns Detected provider or null if format is unknown
 */
function detectProviderFromTaskId(taskId: string): TaskManagerProvider | null {
  if (!taskId || typeof taskId !== 'string') {
    return null;
  }

  const trimmedId = taskId.trim();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CLICKUP
  // Format: alphanumeric, 9 characters (e.g., 86adfe9eb, abc123def)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (/^[a-z0-9]{9}$/i.test(trimmedId)) {
    return 'clickup';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ASANA
  // Format: numeric, 16+ digits (e.g., 1234567890123456)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (/^\d{15,}$/.test(trimmedId)) {
    return 'asana';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LINEAR
  // Formats:
  //   - Prefix + number: ABC-123, PROJ-456
  //   - UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (/^[A-Z]+-\d+$/.test(trimmedId)) {
    return 'linear';
  }
  if (
    /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(
      trimmedId,
    )
  ) {
    return 'linear';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOCAL (generated by NoProviderAdapter)
  // Format: local-timestamp (e.g., local-1732456789012)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (/^local-\d+$/.test(trimmedId)) {
    return 'none';
  }

  // Unknown format
  return null;
}
```

---

### validateProviderMatch()

```typescript
/**
 * Validates if a task ID is compatible with the configured provider.
 * @param taskId - Task ID to validate
 * @param currentProvider - Currently configured provider
 * @returns Validation result with possible warning
 */
function validateProviderMatch(
  taskId: string,
  currentProvider: TaskManagerProvider,
): ValidationResult {
  const detectedProvider = detectProviderFromTaskId(taskId);

  // Unknown format - assume valid
  if (!detectedProvider) {
    return {
      valid: true,
      warning: null,
      detectedProvider: null,
    };
  }

  // 'none' provider accepts any ID (offline mode)
  if (currentProvider === 'none') {
    return {
      valid: true,
      warning:
        `â„¹ï¸ Task ID "${taskId}" detected as ${detectedProvider}, ` +
        `but no provider is configured. Operating in local mode.`,
      detectedProvider,
    };
  }

  // Different providers - incompatibility
  if (detectedProvider !== currentProvider) {
    return {
      valid: false,
      warning:
        `âš ï¸ INCOMPATIBILITY DETECTED\n` +
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
        `Task ID: "${taskId}"\n` +
        `Detected provider: ${detectedProvider}\n` +
        `Configured provider: ${currentProvider}\n\n` +
        `ğŸ’¡ Suggested actions:\n` +
        `   1. Change TASK_MANAGER_PROVIDER to '${detectedProvider}' in .env\n` +
        `   2. Or clear the current session and create a new task\n` +
        `   3. Run /meta/setup-integration to reconfigure`,
      detectedProvider,
    };
  }

  // All OK
  return {
    valid: true,
    warning: null,
    detectedProvider,
  };
}
```

---

### checkProviderConfiguration()

```typescript
/**
 * Checks the complete provider configuration.
 * @returns Object with status and messages
 */
function checkProviderConfiguration(): {
  provider: TaskManagerProvider;
  isConfigured: boolean;
  missingVars: string[];
  optionalVars: { name: string; set: boolean }[];
  message: string;
} {
  const config = detectProvider();

  const missingVars = config.requiredEnvVars.filter(
    (varName) => !process.env[varName],
  );

  const optionalVars = config.optionalEnvVars.map((varName) => ({
    name: varName,
    set: !!process.env[varName],
  }));

  let message: string;

  if (config.provider === 'none') {
    message =
      `â„¹ï¸ No task manager configured.\n` +
      `Commands will work in offline mode.\n` +
      `Run /meta/setup-integration to configure.`;
  } else if (!config.isConfigured) {
    message =
      `âŒ ${config.provider.toUpperCase()} selected but not configured.\n` +
      `Missing variables: ${missingVars.join(', ')}\n` +
      `Run /meta/setup-integration to configure.`;
  } else {
    const optionalStatus = optionalVars
      .map((v) => `   ${v.set ? 'âœ…' : 'âšª'} ${v.name}`)
      .join('\n');

    message =
      `âœ… ${config.provider.toUpperCase()} configured correctly.\n` +
      `Optional variables:\n${optionalStatus}`;
  }

  return {
    provider: config.provider,
    isConfigured: config.isConfigured,
    missingVars,
    optionalVars,
    message,
  };
}
```

---

## ğŸ“Š ID Format Table

| Provider      | Format               | Regex           | Example            |
| ------------- | -------------------- | --------------- | ------------------ |
| ClickUp       | 9 alphanumeric chars | `^[a-z0-9]{9}$` | `86adfe9eb`        |
| Asana         | 15+ digits           | `^\d{15,}$`     | `1234567890123456` |
| Linear (ID)   | PREFIX-NUMBER        | `^[A-Z]+-\d+$`  | `DEV-123`          |
| Linear (UUID) | UUID v4              | UUID regex      | `a1b2c3d4-...`     |
| Local         | local-timestamp      | `^local-\d+$`   | `local-1732456789` |

---

## ğŸ§ª Usage Examples

```typescript
// Detect configured provider
const config = detectProvider();
console.log(`Provider: ${config.provider}`);
console.log(`Configured: ${config.isConfigured}`);

// Validate task ID
const taskId = '86adfe9eb';
const currentProvider = 'asana';
const validation = validateProviderMatch(taskId, currentProvider);

if (!validation.valid) {
  console.warn(validation.warning);
  // Ask the user what to do
}

// Check complete configuration
const status = checkProviderConfiguration();
console.log(status.message);
```

---

## ğŸ“š References

- [Types](./types.md) - Type definitions
- [Factory](./factory.md) - Adapter creation

---

**Version**: 1.0.0
**Created**: 2025-11-24
